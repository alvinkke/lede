#!/bin/sh
# Copyright (C) 2015 OpenWrt.org

. /lib/functions/uci-defaults.sh
. /lib/functions/bos-defaults.sh

ipaddr=$(bos_get_config "net_ip")

# use static protocol when IP is specified
[ -n "$ipaddr" ] && protocol='static' || protocol='dhcp'

board_config_update

ucidef_set_interface_lan 'eth0' "$protocol"

if [ $protocol = 'static' ]; then
    # static protocol requires other parameters
	netmask=$(bos_get_config "net_mask")
	gateway=$(bos_get_config "net_gateway")
	dns_servers=$(bos_get_config "net_dns_servers" | tr , " ")
	json_select network
		json_select lan
			json_add_string ipaddr "$ipaddr"
			[ -n "$netmask" ] && json_add_string netmask "$netmask"
			[ -n "$gateway" ] && json_add_string gateway "$gateway"

			if [ -n "$dns_servers" ]; then
				json_select_array dns_servers
				for dns in $dns_servers; do
					json_add_string "" "$dns"
				done
				json_select ..
			fi
		json_select ..
	json_select ..
fi

board_config_flush

exit 0
